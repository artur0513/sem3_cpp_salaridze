#ifdef GL_ES 
precision mediump float;
#endif
// Использовать как пример
uniform sampler2D effect_texture; // Спрайт который рисуем
uniform sampler2D diffuse_texture; // Текстура куда рисуем

uniform vec2 effect_texture_pos; // Координата и размер спрайта эффекта на всей RenderTexture
uniform vec2 effect_texture_size;

uniform vec2 camera_size;
uniform float time; // Просто время

uniform float time_factor; 
uniform float distortion_factor;// коэффициент искажения

void main() {
	float time_corr = fract(time*time_factor);

	vec2 check_coord = vec2((gl_TexCoord[0].x - effect_texture_pos.x)/effect_texture_size.x, mod((gl_TexCoord[0].y - effect_texture_pos.y)/effect_texture_size.y, 1.0));
	vec4 sprite_color = texture2D(effect_texture, check_coord);
	
	// Проблема в том, что здесь texCoord походу все таки отнсительно всей текстуры. Поэтому нужно все шейдеры перепроверить
	
	vec2 distortion_offset = -(sprite_color.rg*2.0 - vec2(1.0))*distortion_factor*time_corr; // Полученные смещение должно быть в мировых координатах
	
	float layer_rel = pow(1.0 - time_corr, 0.5);

	
	gl_FragColor = texture2D(diffuse_texture, gl_TexCoord[0].xy + distortion_offset/camera_size)*layer_rel + texture2D(diffuse_texture, gl_TexCoord[0].xy)*(1.0 - layer_rel);
	
}